{"version":3,"sources":["../src/add_camera.js"],"names":["define","$","str","ModalFactory","Camera","cmid","mainimage","attemptid","docElement","document","video","getElementById","videoid","canvas","canvasid","on","showpopup","bind","setTimeout","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","catch","prototype","width","height","takepictureid","retakeid","takepicture","context","getContext","drawImage","data","toDataURL","hide","show","val","prop","ajax","url","M","cfg","wwwroot","method","imgBase64","success","response","errorcode","trigger","error","proctoringimage","redirect","window","onbeforeunload","location","href","encodeURI","retake","event","message","create","body","modal","init","verifyduringattempt","setinterval","attr","id","appendTo","class","autoplay","camera","setInterval","e","preventDefault","get_string"],"mappings":"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","sourcesContent":["/**\n * JavaScript class for Camera\n *\n * @subpackage quizproctoring\n * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/modal_factory'],\nfunction($, str, ModalFactory) {\n    var Camera = function(cmid, mainimage = false, attemptid = null) {\n        var docElement = $(document);\n        this.video = document.getElementById(this.videoid);\n        this.canvas = document.getElementById(this.canvasid);\n        this.cmid = cmid;\n        this.mainimage = mainimage;\n        this.attemptid = attemptid;\n        docElement.on('popup', this.showpopup.bind(this));\n        setTimeout(navigator.mediaDevices.getUserMedia({video: true, audio: false})\n            .then(function(stream) {\n                if (this.video) {\n                  this.video.srcObject = stream;\n                  this.video.play();\n                }\n            })\n        .catch(function() {\n            // Console.log(err);\n        }), 10000);\n    };\n    /** @type Tag element contain video. */\n    Camera.prototype.video = false;\n    /** @type String video elemend id. */\n    Camera.prototype.videoid = 'video';\n    /** @type Tag element contain canvas. */\n    Camera.prototype.canvas = false;\n    /** @type String video elemend id. */\n    Camera.prototype.canvasid = 'canvas';\n    /** @type int width of canvas object. */\n    Camera.prototype.width = 320;\n    /** @type int width of canvas object. */\n    Camera.prototype.height = 240;\n    /** @type String element contain takepicture button. */\n    Camera.prototype.takepictureid = 'takepicture';\n    /** @type String element contain retake button. */\n    Camera.prototype.retakeid = 'retake';\n    /** @type int course module id. */\n    Camera.prototype.cmid = false;\n    /** @type bool whether a main image or compare against an image. */\n    Camera.prototype.mainimage = false;\n     /** @type int attempt id. */\n    Camera.prototype.attemptid = false;\n\n    Camera.prototype.takepicture = function() {\n        // Console.log('takepicture function');\n        var context = this.canvas.getContext('2d');\n        context.drawImage(this.video, 0, 0, this.width, this.height);\n        var data = this.canvas.toDataURL('image/png');\n        $('#' + this.videoid).hide();\n        $('#' + this.takepictureid).hide();\n        $('#' + this.canvasid).show();\n        $('#' + this.retakeid).show();\n        $(\"input[name='userimg']\").val(data);\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n        $.ajax({\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n            method: 'POST',\n            data: {imgBase64: data, cmid: this.cmid,attemptid: this.attemptid, mainimage: this.mainimage},\n            success: function(response) {\n                if (response && response.errorcode) {\n                    // Console.log(response.errorcode);\n                    $(\"input[name='userimg']\").val('');\n                    $(document).trigger('popup', response.error);\n                } else {\n                    $(\"#id_submitbutton\").prop(\"disabled\", false);\n                }\n            }\n        });\n    };\n    Camera.prototype.proctoringimage = function() {\n        // Console.log(this.cmid);\n        var context = this.canvas.getContext('2d');\n        context.drawImage(this.video, 0, 0, this.width, this.height);\n        var data = this.canvas.toDataURL('image/png');\n        $.ajax({\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n            method: 'POST',\n            data: {imgBase64: data, cmid: this.cmid, attemptid: this.attemptid, mainimage: this.mainimage},\n            success: function(response) {\n                if (response && response.errorcode) {\n                   // Console.log(response.errorcode);\n                    $(document).trigger('popup', response.error);\n                } else {\n                    if (response.redirect && response.url) {\n                        window.onbeforeunload = null;\n                        window.location.href = encodeURI(response.url);\n                    }\n                }\n            }\n        });\n    };\n\n    Camera.prototype.retake = function() {\n        $(\"input[name='userimg']\").val('');\n        $('#' + this.videoid).show(this.cmid);\n        $('#' + this.takepictureid).show();\n        $('#' + this.canvasid).hide();\n        $('#' + this.retakeid).hide();\n    };\n    Camera.prototype.showpopup = function(event, message) {\n        ModalFactory.create({\n            body: message,\n        }).then(function(modal) {\n            modal.show();\n        });\n    };\n    var init = function(cmid, mainimage, verifyduringattempt = false, attemptid = null, setinterval = 300) {\n        if (verifyduringattempt) {\n            $('<canvas>').attr({id: 'canvas', width: '280', height: '240', 'style': 'display: none;'}).appendTo('body');\n            $('<video>').attr({\n                id:'video',\n                class:'quizaccess_quizproctoring-video',\n                width:'280',\n                height:'240',\n                autoplay:'autoplay'}).appendTo('body');\n            var camera = new Camera(cmid, mainimage, attemptid);\n            setInterval(camera.proctoringimage.bind(camera), setinterval * 1000);\n        } else {\n            var camera = new Camera(cmid, mainimage, attemptid);\n            // Take picture on button click\n            $('#' + camera.takepictureid).on('click', function(e) {\n                e.preventDefault();\n                camera.takepicture();\n            });\n            // Show video again when retake\n            $('#' + camera.retakeid).on('click', function(e) {\n                e.preventDefault();\n                camera.retake();\n            });\n            $(\"#id_submitbutton\").on('click', function(e) {\n                if ($(\"input[name='userimg']\").val() == \"\") {\n                    e.preventDefault();\n                    ModalFactory.create({\n                        body: str.get_string('clickpicture', 'quizaccess_quizproctoring'),\n                    }).then(function(modal) {\n                        modal.show();\n                    });\n                }\n            });\n        }\n    };\n    return {\n        init: init\n    };\n});\n"],"file":"add_camera.min.js"}